<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Desiderativo Analyzer - Motor Sem√°ntico Universal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #0c1a2b;
      --panel: #11263d;
      --accent: #3ba4ff;
      --muted: #7fa6c4;
      --text: #e9f1ff;
      --success: #3dd598;
      --danger: #ff5f6d;
      --warning: #ffb347;
      --grid-gap: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(59,164,255,0.12), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(255,95,109,0.12), transparent 40%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
      padding: 16px;
      gap: 12px;
    }
    header {
      background: linear-gradient(90deg, rgba(59,164,255,0.2), rgba(17,38,61,0.8));
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(59,164,255,0.35);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { margin: 0; font-size: 20px; letter-spacing: 0.05em; text-transform: uppercase; }
    header .badge {
      background: rgba(61,213,152,0.15);
      color: var(--success);
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(61,213,152,0.4);
      font-size: 12px;
      letter-spacing: 0.04em;
    }
    main { display: grid; grid-template-columns: 450px 1fr; gap: var(--grid-gap); min-height: 0; }
    .panel {
      background: var(--panel);
      border-radius: 12px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 8px 24px rgba(0,0,0,0.28);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }
    .section-title {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.03em;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::before {
      content: "";
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--accent); box-shadow: 0 0 12px rgba(59,164,255,0.7);
    }
    .grid { display: grid; gap: 10px; }
    .grid.two { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid.three { grid-template-columns: repeat(3, minmax(0,1fr)); }
    label { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: inline-block; }
    input, textarea, select {
      width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04);
      color: var(--text); font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59,164,255,0.15);
      outline: none;
      background: rgba(255,255,255,0.07);
    }
    textarea { resize: vertical; min-height: 100px; }
    .checkbox-row {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 10px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.04);
    }
    .checkbox-row input[type="checkbox"] { width: 18px; height: 18px; }
    .btn-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap: 10px; }
    button {
      padding: 12px; border: none; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), #5dd0ff);
      color: #031220; font-weight: 700; letter-spacing: 0.02em;
      cursor: pointer; transition: transform 0.15s, box-shadow 0.15s, filter 0.15s;
      box-shadow: 0 10px 25px rgba(59,164,255,0.25);
    }
    button.secondary { background: linear-gradient(135deg, #1f3a55, #254669); color: var(--text); box-shadow: 0 8px 20px rgba(0,0,0,0.18); }
    button.danger { background: linear-gradient(135deg, #ff5f6d, #ffc371); color: #130c0c; box-shadow: 0 10px 24px rgba(255,95,109,0.28); }
    button:hover { transform: translateY(-2px); filter: brightness(1.05); }
    button:active { transform: translateY(0); }
    .result-box {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      padding: 12px;
      display: grid;
      gap: 8px;
    }
    .status {
      padding: 12px; border-radius: 10px; font-weight: 700; letter-spacing: 0.03em;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .status.alta { background: rgba(255,95,109,0.12); color: var(--danger); }
    .status.fuerte { background: rgba(255,179,71,0.12); color: var(--warning); }
    .status.normal { background: rgba(61,213,152,0.12); color: var(--success); }
    .tag { padding: 4px 8px; border-radius: 8px; background: rgba(255,255,255,0.08); font-size: 11px; color: var(--text); }
    .editor-markdown textarea {
      width: 100%; min-height: 260px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      color: var(--text);
      font-family: "JetBrains Mono","Fira Code",monospace;
      padding: 12px;
      white-space: pre-wrap;
    }
    .history {
      font-size: 12px; color: var(--muted); line-height: 1.5;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.05);
      max-height: 160px;
      overflow: auto;
    }
    footer { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: var(--muted); }
    .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); color: var(--text); font-size: 11px; letter-spacing: 0.02em; }
    .catexias-grid { display: grid; gap: 10px; }
    .catexia-row {
      display: grid;
      grid-template-columns: 80px 120px 1fr 90px 1fr 1fr 160px;
      gap: 8px;
      padding: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 10px;
      align-items: start;
    }
    .cambio-extra { margin-top: 6px; display: none; grid-template-columns: 1fr 120px 1fr; gap: 8px; }
    .cambio-extra textarea { min-height: 80px; }
    @media (max-width: 1200px) {
      .catexia-row { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    }
    @media (max-width: 1100px) { main { grid-template-columns: 1fr; } }
    @media (max-width: 640px) {
      body { padding: 10px; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .btn-row { grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); }
    }
  </style>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>DESIDERATIVO ANALYZER ‚Äì MOTOR SEM√ÅNTICO UNIVERSAL</h1>
    <div class="badge">E7 Manejo Ansiedad: 9 (fijo)</div>
  </header>

  <main>
    <section class="panel" id="left-panel">
      <h2 class="section-title">Datos del consultante</h2>
      <div class="grid two">
        <div>
          <label for="siglas">Siglas (ABC)</label>
          <input id="siglas" placeholder="ABC" maxlength="8" value="ABC">
        </div>
        <div>
          <label for="edad">Edad</label>
          <input id="edad" type="number" min="0" max="120" placeholder="28">
        </div>
        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo">
            <option value="M">M</option>
            <option value="F">F</option>
            <option value="O">O</option>
          </select>
        </div>
        <div>
          <label for="observaciones">Observaciones breves</label>
          <input id="observaciones" placeholder="Notas cl√≠nicas / contexto">
        </div>
      </div>

      <h2 class="section-title">Catexias din√°micas (6)</h2>
      <section id="catexias" class="catexias-grid"></section>

      <h2 class="section-title">Ejes (checkbox: selecciona los que detectes)</h2>
      <div class="grid three" id="ejes-checkboxes">
        <label class="checkbox-row"><input type="checkbox" id="eje1" value="E1" checked> <span>E1 Simbolizaci√≥n</span></label>
        <label class="checkbox-row"><input type="checkbox" id="eje2" value="E2" checked> <span>E2 Estructurales</span></label>
        <label class="checkbox-row"><input type="checkbox" id="eje3" value="E3" checked> <span>E3 Pulsiones</span></label>
        <label class="checkbox-row"><input type="checkbox" id="eje4" value="E4" checked> <span>E4 Persecutoria</span></label>
        <label class="checkbox-row"><input type="checkbox" id="eje5" value="E5" checked> <span>E5 Depresiva</span></label>
        <label class="checkbox-row"><input type="checkbox" id="eje6" value="E6" checked> <span>E6 Narcisismo</span></label>
        <label class="checkbox-row"><input type="checkbox" id="eje7" value="E7" checked disabled> <span>E7 Manejo Ansiedad (9 fijo)</span></label>
      </div>

      <div class="btn-row">
        <button onclick="analizar()">Analizar</button>
        <button class="secondary" onclick="generarInforme()">Informe</button>
        <button class="secondary" onclick="generarPDF()">PDF</button>
        <button class="danger" onclick="limpiar()">Limpiar</button>
        <button class="secondary" onclick="mostrarHistorial()">Historial</button>
      </div>
    </section>

    <section class="panel" id="right-panel">
      <h2 class="section-title">Resultado r√°pido</h2>
      <div class="result-box" id="resultado">
        <div id="titulo-resultado" class="status normal">üü¢ Normal</div>
        <div id="detalle-ejes" class="tag">E1=0 E2=0 E3=0 E4=0 E5=0 E6=0 E7=9</div>
        <div><strong>S√≠mbolos detectados:</strong> <span id="simbolos-detectados" class="tag">-</span></div>
        <div><strong>Observaci√≥n cl√≠nica:</strong> <span id="observacion-clinica" class="tag">-</span></div>
      </div>

      <h2 class="section-title">Editor Markdown (informe editable)</h2>
      <div class="editor-markdown">
        <textarea id="editor" spellcheck="false"></textarea>
      </div>

      <h2 class="section-title">Historial (localStorage)</h2>
      <div class="history" id="historial-box"></div>
    </section>
  </main>

  <footer>
    <div class="pill">LocalStorage: historial(50), pdfCounter, ultimoAnalisis</div>
    <div class="pill">HTML2Canvas + jsPDF multip√°gina</div>
  </footer>

  <script>
    const bancoFrases = {
      simbolizacion: [
        "Simbolizaci√≥n empobrecida: dificultad para convertir la vivencia afectiva en representaci√≥n.",
        "Bloqueo simb√≥lico: el sujeto recurre a objetos triviales ante demandas complejas.",
        "Predominio concreto: escasa capacidad metaf√≥rica y uso literal del objeto.",
        "Desplazamiento m√≠nimo: poca plasticidad para asociar significados alternativos.",
        "Rigidez imaginativa: repetici√≥n de formas simples para funciones elaboradas."
      ],
      estructurales: [
        "Necesidad de encuadre r√≠gido: el orden externo sostiene la organizaci√≥n interna.",
        "Apoyo en reglas y rituales para contener la angustia b√°sica.",
        "Estructura defensiva basada en control y previsi√≥n excesiva.",
        "Uso de marcos normativos como soporte del Yo frente a la inestabilidad.",
        "Dependencia de secuencias y turnos para mantener la coherencia conductual."
      ],
      pulsiones: [
        "Expresi√≥n pulsional intensa con modulaci√≥n escasa de la descarga.",
        "Oralidad y b√∫squeda incorporativa como v√≠a principal de satisfacci√≥n.",
        "Tono agresivo/depredador que irrumpe en la escena relacional.",
        "Dificultad para ligar la excitaci√≥n, primando la acci√≥n sobre la elaboraci√≥n.",
        "Impulsividad que bordea la ruptura de l√≠mites y la actuaci√≥n."
      ],
      persecutoria: [
        "Vivencia de amenaza y vigilancia constante en el entorno.",
        "Tendencia a anticipar da√±o o persecuci√≥n por parte de un otro.",
        "Sobrecarga ansiosa ligada a control y escape frente a peligros percibidos.",
        "Lectura paranoide de se√±ales ambiguas, con sesgo a la desconfianza.",
        "Hipervigilancia que desplaza la energ√≠a ps√≠quica a la defensa primaria."
      ],
      depresiva: [
        "Registro de p√©rdida y desvalimiento con matiz melanc√≥lico.",
        "Autorreproche y sentimiento de inadecuaci√≥n persistente.",
        "Tono afectivo sombr√≠o con expectativa de abandono.",
        "Duelos no elaborados que ti√±en la mirada sobre s√≠ y el mundo.",
        "Sensaci√≥n de vac√≠o y soledad estructurante del relato interno."
      ],
      narcisismo: [
        "B√∫squeda de confirmaci√≥n y admiraci√≥n como sost√©n del self.",
        "Grandiosidad defensiva que encubre fragilidad interna.",
        "Idealizaci√≥n del propio rol para asegurar reconocimiento.",
        "Necesidad de ser fuente de bienestar del otro para validar el yo.",
        "Oscilaci√≥n entre autoexaltaci√≥n y temor al desprecio."
      ],
      manejo: [
        "Manejo ansioso elevado: defensas l√°biles y reactividad aumentada.",
        "Afrontamiento sostenido en control y anticipaci√≥n de riesgos.",
        "Estrategias de evitaci√≥n y ritualizaci√≥n para contener la angustia.",
        "Oscilaci√≥n entre hiperactivaci√≥n y agotamiento defensivo.",
        "Tendencia a sobreadaptarse para estabilizar la ansiedad basal."
      ]
    };

    const catexiasConfig = [
      { id: "pos1", label: "Catexia positiva 1" },
      { id: "pos2", label: "Catexia positiva 2" },
      { id: "pos3", label: "Catexia positiva 3" },
      { id: "neg1", label: "Catexia negativa 1" },
      { id: "neg2", label: "Catexia negativa 2" },
      { id: "neg3", label: "Catexia negativa 3" }
    ];

    let ultimoResultado = { ejes: [0,0,0,0,0,0,9] };

    function randomFrom(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

    function crearCatexias() {
      const cont = document.getElementById("catexias");
      cont.innerHTML = "";
      catexiasConfig.forEach((cfg, idx) => {
        const row = document.createElement("div");
        row.className = "catexia-row";
        row.dataset.catexiaId = cfg.id;
        row.innerHTML = `
          <div>
            <label>Orden</label>
            <input type="number" class="orden" min="1" step="1" placeholder="${idx+1}">
          </div>
          <div>
            <label>Reino</label>
            <select class="reino">
              <option value="">-</option>
              <option value="animal">Animal</option>
              <option value="vegetal">Vegetal</option>
              <option value="objeto">Objeto</option>
              <option value="mineral">Mineral</option>
              <option value="abstracto">Abstracto</option>
            </select>
          </div>
          <div>
            <label>S√≠mbolo</label>
            <input class="simbolo" placeholder="S√≠mbolo">
          </div>
          <div>
            <label>TR (seg)</label>
            <input type="number" class="TR" min="0" step="0.1" placeholder="3.5">
          </div>
          <div>
            <label>Racionalizaci√≥n</label>
            <textarea class="racionalizacion" rows="2" placeholder="Motivo o justificaci√≥n"></textarea>
          </div>
          <div>
            <label>Observaciones/comentario</label>
            <textarea class="obsCatexia" rows="2" placeholder="Notas adicionales"></textarea>
          </div>
          <div>
            <div class="checkbox-row">
              <input type="checkbox" class="falloCambioToggle" id="${cfg.id}-fallo">
              <label for="${cfg.id}-fallo">Fallo/Cambio</label>
            </div>
            <div class="cambio-extra">
              <input class="simboloCambio" placeholder="Otro s√≠mbolo">
              <input type="number" class="TRCambio" min="0" step="0.1" placeholder="TR cambio">
              <textarea class="racCambio" rows="2" placeholder="Racionalizaci√≥n/obs. cambio"></textarea>
            </div>
          </div>
        `;
        cont.appendChild(row);
        const toggle = row.querySelector(".falloCambioToggle");
        const extras = row.querySelector(".cambio-extra");
        toggle.addEventListener("change", () => { extras.style.display = toggle.checked ? "grid" : "none"; });
      });
    }

    function leerCatexias() {
      const rows = document.querySelectorAll("#catexias .catexia-row");
      return Array.from(rows).map(r => {
        const falloCambio = r.querySelector(".falloCambioToggle").checked;
        return {
          orden: r.querySelector(".orden").value || "",
          reino: r.querySelector(".reino").value || "",
          simbolo: r.querySelector(".simbolo").value || "",
          TR: r.querySelector(".TR").value || "",
          racionalizacion: r.querySelector(".racionalizacion").value || "",
          observaciones: r.querySelector(".obsCatexia").value || "",
          falloCambio,
          simboloCambio: falloCambio ? (r.querySelector(".simboloCambio").value || "") : "",
          TRCambio: falloCambio ? (r.querySelector(".TRCambio").value || "") : "",
          racCambio: falloCambio ? (r.querySelector(".racCambio").value || "") : ""
        };
      });
    }

    function construirTextoCatexias(catexias) {
      return catexias.map(c =>
        `${c.simbolo} ${c.racionalizacion} ${c.observaciones} ${c.simboloCambio || ""} ${c.racCambio || ""}`
      ).join(" ");
    }

    function extraerSimbolosClinicos(catexias) {
      const res = [];
      catexias.forEach(c => {
        if (c.simbolo) res.push(c.simbolo);
        if (c.falloCambio && c.simboloCambio) res.push(c.simboloCambio);
      });
      return res;
    }

    function setGravedadBadge(scores) {
      const estado = document.getElementById("titulo-resultado");
      const valoresAltos = Object.values(scores).filter(v => v >= 8);
      let nivel = "normal";
      let label = "üü¢ Normal";
      if (valoresAltos.length >= 3) { nivel = "alta"; label = "üî¥ ALTA compatibilidad"; }
      else if (valoresAltos.length >= 2) { nivel = "fuerte"; label = "üü° FUERTE desorg"; }
      estado.className = `status ${nivel}`;
      estado.textContent = label;
      return label;
    }

    function construirObservacion(simbolos, scores) {
      const hits = [];
      if ((scores.E1 ?? 0) >= 8) hits.push("Simbolizaci√≥n pobre o bloqueada.");
      if ((scores.E2 ?? 0) >= 8) hits.push("Estructuraci√≥n r√≠gida / ritual.");
      if ((scores.E3 ?? 0) >= 8) hits.push("Pulsi√≥n oral/depredadora marcada.");
      if ((scores.E4 ?? 0) >= 8) hits.push("Ansiedad persecutoria elevada.");
      if ((scores.E5 ?? 0) >= 8) hits.push("Matiz depresivo evidente.");
      if ((scores.E6 ?? 0) >= 8) hits.push("Narcisismo relacional / grandiosidad.");
      return hits.length ? hits.join(" ") : "Sin signos marcados.";
    }

    function renderResultado(scores, simbolos, obsClinica) {
      document.getElementById("detalle-ejes").textContent =
        `E1=${scores.E1} E2=${scores.E2} E3=${scores.E3} E4=${scores.E4} E5=${scores.E5} E6=${scores.E6} E7=${scores.E7}`;
      document.getElementById("simbolos-detectados").textContent = simbolos.length ? simbolos.join(", ") : "-";
      document.getElementById("observacion-clinica").textContent = obsClinica;
    }

    function analizarUniversal(catexias, obs) {
      const E = [0,0,0,0,0,0,9];
      const textoObs = (obs || "").toLowerCase();
      const pats = {
        E1: [/(no se|no s√©|no puedo|bloqueo|confus|nada)/, /(trivial|cualquiera|lo que sea|simple)/, /(larga explicaci√≥n|demasiado detalle|justificaci√≥n extensa)/],
        E2: [/(juego|mesa|tablero|reglas|turnos|estrategia|dado|cartas)/, /(ritual|orden|estructura|sistema|planificado|met√≥dic)/, /(metal|roca|piedra|acero|hormig√≥n|fortaleza)/],
        E3: [/(comer|masticar|tragar|beber|chupar|sabore|dulce|amargo|picante|comida|banquete|ingest|oral)/, /(depred|agresiv|feroz|salvaj|matar|destruir|atacar|golpear|sangre|cazar|presas|morder|ara√±a venenosa|v√≠bora|serpiente|tigre|leon|lobo)/, /(sucio|putrefacto|visceral|tripas)/],
        E4: [/(escapar|huir|salir corriendo|persec|me persiguen|me vigilan|vigilancia|peligro|amenaza|miedo|parano|acecho|espiando)/, /(volar|alejarme r√°pido|evadir)/],
        E5: [/(soledad|solo|solitaria|abandono|desamparo|tristeza|triste|vac√≠o|duelo|perdida|p√©rdida|nadie me entiende|eternamente)/, /(espinas|cactus|hormiga|insecto diminuto|insignificante)/, /(culpa|remord)/],
        E6: [/(rey|reina|emperador|monarca|trono|corona|omnipot|indestructible|invencible|eterno|inmortal)/, /(orgullo|grandios|ser especial|√∫nico|perfecto|ideal|idol|admir|adoren)/, /(para que est√©n felices conmigo|dar felicidad a otros|que me quieran|que est√©n contentos|hacerlos felices|agradarles|que me amen|para que est√©n bien)/]
      };

      function scoreTexto(t) {
        const s = { E1:0,E2:0,E3:0,E4:0,E5:0,E6:0,E7:E[6] };
        for (const [k, regs] of Object.entries(pats)) {
          for (const r of regs) if (r.test(t)) s[k] = Math.max(s[k], 8);
        }
        const hits = Object.keys(s).filter(k => s[k] >= 8 && k !== "E7").length;
        if (hits >= 3) s.E7 = Math.min(10, s.E7 + 1);
        if (hits <= 1) s.E7 = Math.max(7, s.E7 - 1);
        return s;
      }

      const acumulado = { E1:0,E2:0,E3:0,E4:0,E5:0,E6:0,E7:E[6] };
      let samples = 0;
      catexias.forEach(c => {
        const partes = [
          c.simbolo, c.racionalizacion, c.observaciones,
          c.falloCambio ? c.simboloCambio : "",
          c.falloCambio ? c.racCambio : ""
        ].filter(Boolean).join(" ").toLowerCase();
        if (partes.trim()) {
          const s = scoreTexto(partes);
          Object.keys(acumulado).forEach(k => acumulado[k] += s[k]);
          samples++;
        }
      });
      if (textoObs.trim()) { const sObs = scoreTexto(textoObs); Object.keys(acumulado).forEach(k => acumulado[k] += sObs[k]); samples++; }
      if (samples === 0) samples = 1;
      E[0] = Math.min(10, Math.round(acumulado.E1 / samples));
      E[1] = Math.min(10, Math.round(acumulado.E2 / samples));
      E[2] = Math.min(10, Math.round(acumulado.E3 / samples));
      E[3] = Math.min(10, Math.round(acumulado.E4 / samples));
      E[4] = Math.min(10, Math.round(acumulado.E5 / samples));
      E[5] = Math.min(10, Math.round(acumulado.E6 / samples));
      E[6] = Math.min(10, Math.round(acumulado.E7 / samples));
      return E;
    }

    function analizar() {
      const catexias = leerCatexias();
      const obs = document.getElementById("observaciones").value || "";
      const ejesBase = analizarUniversal(catexias, obs);
      const checks = [
        document.getElementById("eje1"),
        document.getElementById("eje2"),
        document.getElementById("eje3"),
        document.getElementById("eje4"),
        document.getElementById("eje5"),
        document.getElementById("eje6"),
        document.getElementById("eje7")
      ];
      const ejes = [...ejesBase];
      for (let i = 0; i < 6; i++) { if (!checks[i].checked) ejes[i] = 0; }
      const scores = { E1:ejes[0], E2:ejes[1], E3:ejes[2], E4:ejes[3], E5:ejes[4], E6:ejes[5], E7:ejes[6] };

      const gravedad = setGravedadBadge(scores);
      const simbolos = extraerSimbolosClinicos(catexias);
      const obsClinica = construirObservacion(simbolos, scores);
      renderResultado(scores, simbolos, obsClinica);

      const entry = {
        siglas: document.getElementById("siglas").value || "N/D",
        edad: document.getElementById("edad").value || "N/D",
        sexo: document.getElementById("sexo").value || "N/D",
        observaciones: obs,
        texto: construirTextoCatexias(catexias).trim(),
        ejes: ejes,
        gravedad,
        simbolos,
        catexias,
        fecha: new Date().toLocaleString()
      };
      ultimoResultado = entry;
      guardarHistorial(entry);
      localStorage.setItem("ultimoAnalisis", JSON.stringify(entry));
      renderHistorial();
    }

    function guardarHistorial(entry) {
      const key = "historialAnalisis";
      const data = JSON.parse(localStorage.getItem(key) || "[]");
      data.unshift(entry);
      localStorage.setItem(key, JSON.stringify(data.slice(0, 50)));
      localStorage.setItem("ultimoAnalisis", JSON.stringify(entry));
    }

    function renderHistorial() {
      const box = document.getElementById("historial-box");
      const data = JSON.parse(localStorage.getItem("historialAnalisis") || "[]");
      if (!data.length) { box.innerText = "Sin registros a√∫n."; return; }
      box.innerHTML = data.slice(0, 8).map((d, idx) => {
        return `<div class="tag">#${idx+1} ${d.siglas || "N/D"} (${d.fecha || "-"}) - ${d.gravedad || "-"}</div>`;
      }).join("");
    }

    function mostrarHistorial() {
      const data = JSON.parse(localStorage.getItem("historialAnalisis") || "[]");
      if (!data.length) { alert("Sin historial."); return; }
      const lines = data.slice(0, 10).map((d, i) => {
        let fechaCorta = "";
        if (d.fecha) {
          const dt = new Date(d.fecha);
          fechaCorta = isNaN(dt.getTime()) ? d.fecha : dt.toLocaleString();
        }
        return `${i + 1}. ${d.siglas || "N/D"} | ${d.gravedad || "-"} | ${fechaCorta || "-"}`;
      });
      alert(lines.join("\n"));
    }

    async function generarPDF() {
      const { jsPDF } = window.jspdf;
      const body = document.body;
      const pdfCounter = parseInt(localStorage.getItem("pdfCounter") || "0", 10) + 1;
      localStorage.setItem("pdfCounter", pdfCounter);
      const siglas = document.getElementById("siglas").value || "N/D";
      const filename = `Informe-${pdfCounter}_${siglas}.pdf`;

      const canvas = await html2canvas(body, { scale: 2, useCORS: true, logging: false, windowWidth: body.scrollWidth, windowHeight: body.scrollHeight });
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "pt", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
      const imgWidth = canvas.width * ratio;
      const imgHeight = canvas.height * ratio;

      let heightLeft = imgHeight;
      let position = 0;
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }
      pdf.save(filename);
      alert("PDF generado: " + filename);
    }

    function generarInforme() {
      const raw = localStorage.getItem("ultimoAnalisis");
      if (!raw) { alert("No hay an√°lisis previo para generar informe."); return; }
      const ua = JSON.parse(raw);
      const eArr = Array.isArray(ua.ejes) ? ua.ejes : [
        ua.ejes?.E1 ?? 0, ua.ejes?.E2 ?? 0, ua.ejes?.E3 ?? 0, ua.ejes?.E4 ?? 0,
        ua.ejes?.E5 ?? 0, ua.ejes?.E6 ?? 0, ua.ejes?.E7 ?? 0
      ];
      const gravedad = ua.gravedad || "üü¢ Normal";
      const siglas = ua.siglas || "N/D";
      const catexias = ua.catexias || [];
      const obs = ua.obs || ua.observaciones || "";
      const fecha = ua.fecha || new Date().toLocaleString();

      const isAlta = gravedad.includes("üî¥");
      const isFuerte = gravedad.includes("üü°");

      const textoCatexias = catexias.map(c =>
        [
          c.simbolo, c.racionalizacion, c.observaciones,
          c.falloCambio ? c.simboloCambio : "",
          c.falloCambio ? c.racCambio : ""
        ].filter(Boolean).join(" ").toLowerCase()
      ).join(" ");
      const obsLower = (obs || "").toLowerCase();

      const oralPattern = /(comer|masticar|tragar|beber|chupar|sabore|dulce|amargo|picante|comida|banquete|ingest|oral)/;
      const altruNarcPattern = /(felicidad|felices conmigo|que me quieran|que est√©n contentos|dar felicidad a otros|hacerlos felices|agradarles|que me amen|para que est√©n bien)/;

      const hayOral = oralPattern.test(textoCatexias);
      const hayAltruNarc = altruNarcPattern.test(textoCatexias) || altruNarcPattern.test(obsLower);

      function refuerzo(nombre, idx) {
        return ((isAlta || isFuerte) && (eArr[idx] ?? 0) >= 8)
          ? `- Refuerzo cl√≠nico: el eje ${nombre} presenta peso elevado en la s√≠ntesis.`
          : "";
      }

      function seccion(nombre, idx, frasesBanco, extraFn) {
        const val = eArr[idx] ?? 0;
        const lines = [
          `## ${idx + 1}. ${nombre}`,
          `**E${idx + 1} = ${val}/10**`,
          `- ${randomFrom(frasesBanco)}`
        ];
        const r = refuerzo(nombre, idx);
        if (r) lines.push(r);
        if (typeof extraFn === "function") {
          const extra = extraFn();
          if (extra) lines.push(extra);
        }
        return lines.join("\n");
      }

      const md = [
        "# DESIDERATIVO ANALYZER ‚Äì INFORME",
        `**Siglas:** ${siglas} | **Fecha:** ${fecha} | **Gravedad:** ${gravedad}`,
        `**Ejes:** E1=${eArr[0] ?? 0}, E2=${eArr[1] ?? 0}, E3=${eArr[2] ?? 0}, E4=${eArr[3] ?? 0}, E5=${eArr[4] ?? 0}, E6=${eArr[5] ?? 0}, E7=${eArr[6] ?? 0}`,
        "",
        seccion("SIMBOLIZACI√ìN", 0, bancoFrases.simbolizacion),
        "",
        seccion("ESTRUCTURALES", 1, bancoFrases.estructurales),
        "",
        seccion("PULSIONES", 2, bancoFrases.pulsiones, () => hayOral ? "- Indicador adicional: presencia de imaginer√≠a oral/comestible." : ""),
        "",
        seccion("PERSECUTORIA", 3, bancoFrases.persecutoria),
        "",
        seccion("DEPRESIVA", 4, bancoFrases.depresiva),
        "",
        seccion("NARCISISMO", 5, bancoFrases.narcisismo, () => hayAltruNarc ? "- Indicador adicional: racionalizaciones ligadas a ser querido/dar felicidad al otro." : ""),
        "",
        seccion("MANEJO DE ANSIEDAD", 6, bancoFrases.manejo)
      ].join("\n");

      const editor = document.getElementById("editor");
      if (editor) editor.value = md;
    }

    function limpiar() {
      document.getElementById("siglas").value = "ABC";
      document.getElementById("edad").value = "";
      document.getElementById("sexo").value = "M";
      document.getElementById("observaciones").value = "";
      document.querySelectorAll("#catexias .catexia-row").forEach(box => {
        box.querySelectorAll("input, textarea, select").forEach(inp => {
          if (inp.type === "checkbox") inp.checked = false;
          else inp.value = "";
        });
        const extra = box.querySelector(".cambio-extra");
        if (extra) extra.style.display = "none";
      });
      for (let i = 1; i <= 7; i++) {
        const cb = document.getElementById(`eje${i}`);
        if (!cb) continue;
        cb.checked = true;
        cb.disabled = (i === 7);
      }
      const editor = document.getElementById("editor");
      if (editor) editor.value = "";
      document.getElementById("detalle-ejes").textContent = "E1=0 E2=0 E3=0 E4=0 E5=0 E6=0 E7=9";
      document.getElementById("titulo-resultado").className = "status normal";
      document.getElementById("titulo-resultado").textContent = "üü¢ Normal";
      document.getElementById("simbolos-detectados").textContent = "-";
      document.getElementById("observacion-clinica").textContent = "-";
      ultimoResultado = { ejes: [0,0,0,0,0,0,9] };
    }

    window.onload = () => {
      crearCatexias();
      renderHistorial();
      const ultimo = localStorage.getItem("ultimoAnalisis");
      if (ultimo) {
        try {
          const data = JSON.parse(ultimo);
          document.getElementById("siglas").value = data.siglas || "ABC";
          document.getElementById("edad").value = data.edad || "";
          document.getElementById("sexo").value = data.sexo || "M";
          document.getElementById("observaciones").value = data.observaciones || data.obs || "";
          if (data.ejes) {
            const scores = Array.isArray(data.ejes) ? {
              E1:data.ejes[0],E2:data.ejes[1],E3:data.ejes[2],E4:data.ejes[3],E5:data.ejes[4],E6:data.ejes[5],E7:data.ejes[6]
            } : data.ejes;
            const gravedad = data.gravedad || setGravedadBadge(scores);
            setGravedadBadge(scores);
            renderResultado(scores, data.simbolos || [], construirObservacion(data.simbolos||[], scores));
            document.getElementById("detalle-ejes").textContent =
              `E1=${scores.E1} E2=${scores.E2} E3=${scores.E3} E4=${scores.E4} E5=${scores.E5} E6=${scores.E6} E7=${scores.E7}`;
            document.getElementById("titulo-resultado").textContent = gravedad;
          }
          const editor = document.getElementById("editor");
          if (editor) editor.value = "";
        } catch(e){ console.warn(e); }
      }
    };
  </script>
</body>
</html>
